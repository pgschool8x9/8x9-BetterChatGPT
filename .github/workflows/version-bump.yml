name: Auto Version Bump

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version_type:
        description: 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã®ç¨®é¡'
        required: true
        default: 'minor'
        type: choice
        options:
        - patch  # 1.21.0 â†’ 1.21.1 (ãƒã‚°ä¿®æ­£)
        - minor  # 1.21.0 â†’ 1.22.0 (æ–°æ©Ÿèƒ½)
        - major  # 1.21.0 â†’ 2.0.0 (ç ´å£Šçš„å¤‰æ›´)

jobs:
  version-bump:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'ğŸ”– ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—')"
    permissions:
      contents: write
      pull-requests: write
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Node.jsè¨­å®š
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰å¤‰æ›´ç¨®åˆ¥ã‚’åˆ¤å®š
        id: commit-analysis
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: $COMMIT_MSG"
          
          if [[ $COMMIT_MSG =~ ^BREAKING|^feat!|^fix! ]]; then
            echo "version_type=major" >> "$GITHUB_OUTPUT"
            echo "åˆ¤å®šçµæœ: major (ç ´å£Šçš„å¤‰æ›´)"
          elif [[ $COMMIT_MSG =~ ^feat ]]; then
            echo "version_type=minor" >> "$GITHUB_OUTPUT"
            echo "åˆ¤å®šçµæœ: minor (æ–°æ©Ÿèƒ½)"
          else
            echo "version_type=patch" >> "$GITHUB_OUTPUT"
            echo "åˆ¤å®šçµæœ: patch (ãƒã‚°ä¿®æ­£ãƒ»æ”¹å–„)"
          fi

      - name: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œ
        id: version-update
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ‰‹å‹•å®Ÿè¡Œæ™‚ã¯å…¥åŠ›å€¤ã€è‡ªå‹•å®Ÿè¡Œæ™‚ã¯åˆ¤å®šçµæœã‚’ä½¿ç”¨
          VERSION_TYPE=${{ github.event.inputs.version_type || steps.commit-analysis.outputs.version_type }}
          echo "é©ç”¨ã™ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—: $VERSION_TYPE"
          
          # ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $CURRENT_VERSION"
          
          # package.jsonã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°ï¼ˆã‚¿ã‚°ã¯ä½œæˆã—ãªã„ï¼‰
          npm version $VERSION_TYPE --no-git-tag-version
          
          # æ›´æ–°ã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          
          # ã‚³ãƒŸãƒƒãƒˆã¨ã‚¿ã‚°ã‚’ä½œæˆ
          git add package.json package-lock.json
          git commit -m "ğŸ”– ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—: v$NEW_VERSION"
          git tag "v$NEW_VERSION"
          
          # ãƒªãƒ¢ãƒ¼ãƒˆã«ãƒ—ãƒƒã‚·ãƒ¥
          git push origin main
          git push origin "v$NEW_VERSION"
          
          echo "âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ: $CURRENT_VERSION â†’ $NEW_VERSION"

      - name: Build and Deploy to GitHub Pages
        run: |
          # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          yarn install
          
          # ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
          yarn build
        env:
          VITE_GOOGLE_CLIENT_ID: ${{ secrets.GCLIENT }}
      
      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆä½œæˆ
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version-update.outputs.new_version }}
          name: Release v${{ steps.version-update.outputs.new_version }}
          body: |
            ## å¤‰æ›´å†…å®¹
            - è‡ªå‹•ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—: ${{ steps.commit-analysis.outputs.version_type }}
            
            ### ã‚³ãƒŸãƒƒãƒˆå±¥æ­´
            ${{ github.event.head_commit.message }}
          draft: false
          prerelease: false